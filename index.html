<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>üè† MinPris ‚Äì tilbudskalkulator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --primary: #2563eb;
      --dark: #0f172a;
      --muted: #64748b;
      --success: #16a34a;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #eef2ff, #f8fafc);
      padding: 16px;
      color: var(--dark);
    }

    .box {
      max-width: 760px;
      margin: auto;
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.08);
    }

    h1 {
      margin-bottom: 6px;
      font-size: 1.6rem;
    }

    .subtitle {
      color: var(--muted);
      margin-top: 0;
      margin-bottom: 20px;
    }

    label {
      font-weight: 600;
      margin-top: 14px;
      display: block;
    }

    input, textarea {
      width: 100%;
      padding: 12px;
      font-size: 15px;
      border-radius: 10px;
      border: 1px solid #cbd5f5;
      margin-top: 6px;
    }

    textarea {
      resize: vertical;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 600px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    .maps-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
      font-size: 13px;
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
    }

    .buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    button {
      flex: 1;
      padding: 14px;
      font-size: 15px;
      font-weight: 600;
      border-radius: 12px;
      border: none;
      cursor: pointer;
    }

    #beregnBtn {
      background: var(--dark);
      color: white;
    }

    #aiBtn {
      background: var(--primary);
      color: white;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    pre {
      background: #f1f5f9;
      padding: 16px;
      border-radius: 12px;
      white-space: pre-wrap;
      margin-top: 10px;
    }

    #kopierBtn {
      margin-top: 10px;
      background: var(--success);
      color: white;
      width: 100%;
    }
  </style>
</head>

<body>
  <div class="box">
    <h1>üè† MinPris ‚Äì tilbudskalkulator</h1>
    <p class="subtitle">Kalkuler pris og generer profesjonell tilbudstekst</p>

    <label>Jobbbeskrivelse</label>
    <textarea id="beskrivelse" rows="4" placeholder="Beskriv jobben, f.eks: 40t riving, 20t rengj√∏ring"></textarea>

    <label>Timepris (kr)</label>
    <input id="timepris" type="number" />

    <div class="grid-2">
      <div>
        <label>Kilometer per dag</label>
        <input id="kmPerDag" type="number" />

        <a
          href="https://www.google.com/maps"
          target="_blank"
          class="maps-link"
        >
          üó∫Ô∏è Usikker? Sjekk Google Maps
        </a>
      </div>

      <div>
        <label>Pris per km (kr)</label>
        <input id="prisPerKm" type="number" value="15" />
      </div>
    </div>

    <label>Avfall (kr)</label>
    <input id="avfall" type="number" />

    <label>Materiell totalt (kr)</label>
    <input id="materiell" type="number" />

    <label>Forbruk HMS per dag (kr)</label>
    <input id="hms" type="number" />

    <div class="buttons">
      <button id="beregnBtn">Beregn</button>
      <button id="aiBtn" disabled>Generer tilbudstekst</button>
    </div>

    <h3>Resultat</h3>
    <pre id="resultat"></pre>

    <h3>Tilbudstekst</h3>
    <pre id="tilbud"></pre>
    <button id="kopierBtn" style="display:none;">Kopier tekst</button>
  </div>

<script>
let kalkyle = null;

document.getElementById("beregnBtn").onclick = () => {
  const beskrivelse = document.getElementById("beskrivelse").value;
  const timepris = Number(document.getElementById("timepris").value);
  const kmPerDag = Number(document.getElementById("kmPerDag").value);
  const prisPerKm = Number(document.getElementById("prisPerKm").value || 15);
  const avfall = Number(document.getElementById("avfall").value || 0);
  const materiell = Number(document.getElementById("materiell").value || 0);
  const hmsPerDag = Number(document.getElementById("hms").value || 0);

  if (!beskrivelse || !timepris || !kmPerDag) {
    alert("Fyll inn beskrivelse, timepris og km per dag");
    return;
  }

  const timer =
    (beskrivelse.match(/(\d+)\s*t/gi) || [])
      .map(x => Number(x.replace(/\D/g, "")))
      .reduce((a,b) => a + b, 0);

  const dager = Math.max(1, Math.ceil(timer / 7.5));
  const arbeid = timer * timepris;
  const kj√∏ring = dager * kmPerDag * prisPerKm;
  const hms = dager * hmsPerDag;

  const totalEksMva = arbeid + kj√∏ring + avfall + materiell + hms;
  const mva = totalEksMva * 0.25;
  const totalInkMva = totalEksMva + mva;

  kalkyle = {
    beskrivelse,
    timer,
    dager,
    timepris,
    kmPerDag,
    prisPerKm,
    arbeid,
    kj√∏ring,
    avfall,
    materiell,
    hms,
    totalEksMva,
    totalInkMva
  };

  document.getElementById("resultat").textContent =
`Dager: ${dager}
Timer: ${timer}

Arbeid: ${arbeid} kr
Kj√∏ring: ${kj√∏ring} kr
Avfall: ${avfall} kr
Materiell: ${materiell} kr
HMS: ${hms} kr

TOTAL eks. mva: ${Math.round(totalEksMva)} kr
MVA (25 %): ${Math.round(mva)} kr
TOTAL inkl. mva: ${Math.round(totalInkMva)} kr`;

  document.getElementById("aiBtn").disabled = false;
};

document.getElementById("aiBtn").onclick = async () => {
  const tilbudEl = document.getElementById("tilbud");
  const kopiBtn = document.getElementById("kopierBtn");

  tilbudEl.textContent = "Genererer tilbudstekst‚Ä¶";
  kopiBtn.style.display = "none";

  try {
    const res = await fetch("/api/ai", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(kalkyle)
    });

    if (!res.ok) {
      tilbudEl.textContent = await res.text();
      return;
    }

    const data = await res.json();
    tilbudEl.textContent = data.text || "AI returnerte ingen tekst.";
    kopiBtn.style.display = "block";

  } catch (err) {
    tilbudEl.textContent = "Teknisk feil: " + err.message;
  }
};

document.getElementById("kopierBtn").onclick = () => {
  navigator.clipboard.writeText(
    document.getElementById("tilbud").textContent
  );
  alert("Tilbudstekst kopiert");
};
</script>
</body>
</html>
