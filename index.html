<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>MinPris â€“ tilbudskalkulator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .box {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
    }
    input, textarea, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      font-size: 16px;
    }
    button {
      background: #111;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    pre {
      background: #eee;
      padding: 10px;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <div class="box">
    <h1>MinPris â€“ tilbudskalkulator</h1>

    <textarea id="beskrivelse" rows="4" placeholder="Beskriv jobben..."></textarea>

    <input id="timepris" type="number" placeholder="Timepris (kr)" />
    <input id="kmPerDag" type="number" placeholder="Km per dag" />
    <input id="avfall" type="number" placeholder="Avfall (kr)" />
    <input id="materiell" type="number" placeholder="Materiell totalt (kr)" />
    <input id="hms" type="number" placeholder="Forbruk HMS per dag (kr)" />

    <button id="beregnBtn">Beregn</button>
    <button id="aiBtn" disabled>Generer tilbudstekst</button>

    <h3>Resultat</h3>
    <pre id="resultat"></pre>

    <h3>Tilbudstekst</h3>
    <pre id="tilbud"></pre>
    <button id="kopierBtn" style="display:none;">Kopier tekst</button>
  </div>

<script>
let kalkyle = null;

document.getElementById("beregnBtn").onclick = () => {
  const beskrivelse = document.getElementById("beskrivelse").value;
  const timepris = Number(document.getElementById("timepris").value);
  const kmPerDag = Number(document.getElementById("kmPerDag").value);
  const avfall = Number(document.getElementById("avfall").value || 0);
  const materiell = Number(document.getElementById("materiell").value || 0);
  const hms = Number(document.getElementById("hms").value || 0);

  if (!beskrivelse || !timepris || !kmPerDag) {
    alert("Fyll inn beskrivelse, timepris og km per dag");
    return;
  }

  // ðŸ”¹ Enkel AI-fri parsing av timer (fallback)
  const timer =
    (beskrivelse.match(/(\d+)\s*t/gi) || [])
      .map(x => Number(x.replace(/\D/g, "")))
      .reduce((a,b) => a + b, 0);

  const dager = Math.ceil(timer / 7.5);
  const arbeid = timer * timepris;
  const kjÃ¸ring = dager * kmPerDag * 15;
  const hmsTotal = dager * hms;

  const total =
    arbeid + kjÃ¸ring + avfall + materiell + hmsTotal;

  kalkyle = {
    beskrivelse,
    timer,
    dager,
    arbeid,
    kjÃ¸ring,
    avfall,
    materiell,
    hms: hmsTotal,
    total
  };

  document.getElementById("resultat").textContent =
`Dager: ${dager}
Timer: ${timer}
Arbeid: ${arbeid} kr
KjÃ¸ring: ${kjÃ¸ring} kr
Avfall: ${avfall} kr
Materiell: ${materiell} kr
HMS: ${hmsTotal} kr

TOTAL: ${total} kr`;

  document.getElementById("aiBtn").disabled = false;
};

document.getElementById("aiBtn").onclick = async () => {
  document.getElementById("tilbud").textContent = "Genererer tekst...";
  document.getElementById("kopierBtn").style.display = "none";

  const res = await fetch("/api/ai", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(kalkyle)
  });

  const data = await res.json();

  if (!data.text) {
    document.getElementById("tilbud").textContent =
      "Noe gikk galt med AI-generering.";
    return;
  }

  document.getElementById("tilbud").textContent = data.text;
  document.getElementById("kopierBtn").style.display = "block";
};

document.getElementById("kopierBtn").onclick = () => {
  navigator.clipboard.writeText(
    document.getElementById("tilbud").textContent
  );
  alert("Tekst kopiert");
};
</script>
</body>
</html>
